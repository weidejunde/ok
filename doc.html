<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Drawing</title>
    <style>
        #canvas {
            border: 1px solid black;
        }
        #character-list {
            margin-top: 20px;
        }
        .character-item {
            margin: 10px 0;
        }
        #output {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Vẽ Hình và Hiển Thị Chữ</h1>
    <canvas id="canvas" width="400" height="400"></canvas>
    <br>
    <input type="text" id="character-input" placeholder="Nhập ký tự" />
    <button id="save">Lưu</button>
    <button id="clear">Xóa</button>
    <input type="file" id="file-input" accept=".json" />
    <button id="save-edited">Lưu Dữ Liệu Đã Chỉnh Sửa</button>
    <div id="result"></div>
    <div id="character-list"></div> <!-- Khu vực hiển thị danh sách chữ -->
    <div id="output"></div> <!-- Khu vực hiển thị chữ tương ứng -->

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let currentCharacter = "";
        let paths = [];
        let trainingData = []; // Dữ liệu huấn luyện

        canvas.addEventListener('mousedown', () => {
            drawing = true;
            paths.push([]);
        });

        canvas.addEventListener('mouseup', () => {
            drawing = false;
            ctx.beginPath();
            recognizeDrawing(); // Nhận diện hình vẽ khi người dùng kết thúc vẽ
        });

        canvas.addEventListener('mousemove', draw);

        function draw(event) {
            if (!drawing) return;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';

            const x = event.clientX - canvas.offsetLeft;
            const y = event.clientY - canvas.offsetTop;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
            paths[paths.length - 1].push({ x, y });
        }

        document.getElementById('clear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentCharacter = "";
            paths = [];
            document.getElementById('result').innerText = '';
            document.getElementById('output').innerText = ''; // Xóa chữ hiển thị
        });

        document.getElementById('save').addEventListener('click', () => {
            currentCharacter = document.getElementById('character-input').value; // Lấy ký tự từ input
            if (currentCharacter) {
                const svgData = generateSVG(paths);
                trainingData.push({
                    label: currentCharacter,
                    image: svgData, // Lưu SVG
                });
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                currentCharacter = "";
                paths = [];
                document.getElementById('result').innerText = 'Dữ liệu đã được lưu!';
                displayCharacterList(trainingData); // Cập nhật danh sách
            } else {
                alert("Vui lòng nhập ký tự trước khi lưu!");
            }
        });

        document.getElementById('file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = e.target.result;
                        trainingData = JSON.parse(jsonData);
                        displayCharacterList(trainingData); // Hi ển thị danh sách chữ
                    } catch (error) {
                        console.error("Lỗi khi phân tích cú pháp JSON:", error);
                    }
                };
                reader.readAsText(file);
            }
        });

        function generateSVG(paths) {
            let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400">`;
            svgContent += `<path d="`;
            paths.forEach(path => {
                path.forEach((point, index) => {
                    svgContent += (index === 0 ? `M ${point.x} ${point.y} ` : `L ${point.x} ${point.y} `);
                });
            });
            svgContent += `" fill="none" stroke="black" stroke-width="2"/>`;
            svgContent += `</svg>`;
            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgContent);
        }

        function displayCharacterList(data) {
            const characterListDiv = document.getElementById('character-list');
            characterListDiv.innerHTML = ''; // Xóa danh sách cũ
            data.forEach((item, index) => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                
                // Tạo phần tử hình ảnh
                const img = document.createElement('img');
                img.src = item.image; // Đặt nguồn img.alt = item.label;
                img.style.width = '50px'; // Kích thước hình ảnh
                img.style.height = '50px'; // Kích thước hình ảnh

                // Tạo phần tử nhãn
                const label = document.createElement('span');
                label.innerText = item.label;

                // Tạo nút chỉnh sửa
                const editButton = document.createElement('button');
                editButton.innerText = 'Chỉnh sửa';
                editButton.onclick = () => editCharacter(index);

                // Tạo nút xóa
                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Xóa';
                deleteButton.onclick = () => deleteCharacter(index);

                // Thêm hình ảnh, nhãn và nút vào phần tử danh sách
                characterItem.appendChild(img);
                characterItem.appendChild(label);
                characterItem.appendChild(editButton);
                characterItem.appendChild(deleteButton);
                characterListDiv.appendChild(characterItem);
            });
        }

        function editCharacter(index) {
            const newLabel = prompt("Nhập nhãn mới:", trainingData[index].label);
            if (newLabel !== null) {
                trainingData[index].label = newLabel;
                displayCharacterList(trainingData); // Cập nhật danh sách
            }
        }

        function deleteCharacter(index) {
            if (confirm("Bạn có chắc chắn muốn xóa mục này?")) {
                trainingData.splice(index, 1);
                displayCharacterList(trainingData); // Cập nhật danh sách
            }
        }

        function recognizeDrawing() {
            // Giả lập nhận diện hình vẽ
            // Ở đây bạn có thể thêm logic để nhận diện hình vẽ và tìm kiếm chữ tương ứng
            const recognizedCharacter = trainingData.length > 0 ? trainingData[0].label : "Không có chữ nào";
            document.getElementById('output').innerText = recognizedCharacter; // Hiển thị chữ tương ứng
        }

        document.getElementById('save-edited').addEventListener('click', () => {
            const jsonData = JSON.stringify(trainingData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'edited_data.json';
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>